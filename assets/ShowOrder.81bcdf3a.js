import{Q as u}from"./QBtn.d6aa4958.js";import{a as ge,b as A,Q as S}from"./QTable.9cab5d86.js";import{c as te,h as ve}from"./render.6364fbb8.js";import{c as ye,h as ae,W as we,_ as be,d as Ce,t as d,a5 as y,f as a,x as r,F as C,r as c,o as ke,A as s,a6 as I,v as g,y as b,a8 as f,z as T,p as L,aq as W,ar as Y}from"./index.847c9bb9.js";import{Q as he}from"./QPage.0e392090.js";import{g as G,c as X,d as k,a as D,b as R,p as Z,Q as $,e as O}from"./firebaseConfig.4f4498d5.js";import{f as N,Q as B}from"./use-timeout.602f94f8.js";import{Q as M}from"./QList.57ede4a3.js";import{Q as U}from"./QCardActions.8db9fe51.js";import{Q as E}from"./QDialog.6f613d3d.js";import{a as Ie}from"./QSelect.836893ec.js";import{Q as Oe}from"./QInput.b0df898b.js";import{O as x}from"./interfaces.86b2316d.js";import{i as Se,g as Te,f as ee}from"./firebaseDateFormatter.19ab7f63.js";import{S as P}from"./sweetalert2.all.9f9dcfd4.js";import{u as De}from"./device-store.1ef5a44d.js";import"./format.3c3ea85b.js";var _=te({name:"QTr",props:{props:Object,noHover:Boolean},setup(e,{slots:l}){const o=ye(()=>"q-tr"+(e.props===void 0||e.props.header===!0?"":" "+e.props.__trClass)+(e.noHover===!0?" q-tr--no-hover":""));return()=>ae("tr",{class:o.value},ve(l.default))}});const Qe=ae("div",{class:"q-space"});var j=te({name:"QSpace",setup(){return()=>Qe}});const Pe=we("orderStore",{state:()=>({orders:[],items:[]}),getters:{},actions:{async fetchItems(){const e=await G(X(k,"items"));this.items=e.docs.map(l=>{const o=l.data();return{id:l.id,name:o.name,price:o.price,category:o.category,imageUrl:o.imageUrl}})},async fetchOrders(){const e=await G(X(k,"order"));this.orders=e.docs.map(l=>{const o=l.data();return o.itemSummary&&!Array.isArray(o.itemSummary.items)&&(o.itemSummary.items=[o.itemSummary.items]),o}).sort((l,o)=>o.startTime-l.startTime)},async closeOrder(e){const l=D(k,"order",e.orderId),o=D(k,"rooms",e.deviceId);await R(o,{isAvailable:!0});const p=Math.floor(new Date().getTime()/1e3),m=Math.ceil((p-e.startTime)/(60*60)),v=m*e.roomRate;let t=0;e.itemSummary?t=e.itemSummary.totalPrices+v:t=v,await R(l,{status:x.Completed,endTime:p,durationHours:m,roomTotalPrice:v,grandTotalPrice:t})},async createNeworder(e){let l="",o=!1;for(;!o;)l=Te(),o=await Se(l);const p=Math.floor(new Date().getTime()/1e3),m={orderId:l,deviceId:e.id,roomRate:e.price,startTime:p,status:x.Ongoing};if(!e.id)throw new Error("Room ID is not set");e.isAvailable=!1;const v=D(k,"rooms",e.id);await Z(v,{...e});const t=D(k,"order",l);await Z(t,{...m})},async updateOrderItem(e,l){const o=D(k,"order",e);let p=0,m=0;l.forEach(t=>{p+=Number(t.quantity),m+=t.price}),await R(o,{itemSummary:{totalItem:p,totalPrices:m,items:l}})}}});const _e=Ce({setup(){const e=Pe(),l=De(),o=c([]),p=c([]),m=c(!1),v=c([]),t=c({}),i=c([]),q=c(!1),h=c({}),Q=c([]),w=c(null),z=c(!1),F=c([]),V=c({}),le=async n=>{await l.fetchPrinter(),F.value=l.printers,h.value=n,z.value=!0},re=async n=>{h.value=n,await e.fetchItems(),i.value=e.items,n.itemSummary&&(Q.value=n.itemSummary.items),q.value=!0},oe=async()=>{await e.updateOrderItem(h.value.orderId,Q.value),window.location.reload()},ne=()=>{if(w.value){const n={itemId:w.value.id,name:w.value.name,quantity:w.value.quantity,price:w.value.price*w.value.quantity};console.log(n),Q.value.push(n),w.value=null}},se=()=>{q.value=!1,h.value={}},ie=async()=>{await l.fetchRoom(),v.value=l.rooms.filter(n=>n.isAvailable),m.value=!0},de=n=>{t.value=n},ue=async()=>{t.value&&(await e.createNeworder(t.value),await e.fetchOrders(),o.value=e.orders,P.fire("Success","Create Order Sukses!","success"),m.value=!1)},ce=[{name:"orderId",align:"left",label:"Order ID",field:"orderId",sortable:!0},{name:"deviceId",align:"left",label:"Device ID",field:"deviceId",sortable:!0},{name:"startTime",align:"left",label:"Start Time",field:n=>ee(n.startTime),sortable:!0},{name:"endTime",align:"left",label:"End Time",field:n=>ee(n.endTime),sortable:!0},{name:"grandTotalPrice",align:"left",label:"Total Price",field:"grandTotalPrice",sortable:!0},{name:"status",align:"left",label:"Status",field:"status",sortable:!0,classes:n=>{switch(n.status){case"completed":return"bg-green";case"ongoing":return"bg-blue";default:return"bg-orange"}}}],H=async()=>{await e.fetchOrders(),o.value=e.orders,console.log(o.value)},me=n=>{V.value=n},fe=async()=>{try{const n=JSON.parse(JSON.stringify(h.value)),J=V.value.id;(await fetch("http://localhost:3000/print",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({printerIP:J,order:n})})).ok?console.log("Print job sent to printer"):console.error("Failed to send print job")}catch(n){console.log(n)}},pe=async n=>{if((await P.fire({title:`Order ${n.orderId}`,text:"Apakah Anda Close Order?",icon:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"Ya, Close Order",cancelButtonText:"Batal"})).isConfirmed)try{await e.closeOrder(n),await e.fetchOrders(),o.value=e.orders,P.fire("Success","Close Order Sukses!","success")}catch(K){console.error("Error close order:",K),P.fire("Error","Ada Kendala Saat Close Order.","error")}};return ke(H),{orders:o,columns:ce,expanded:p,openNewOrder:ie,closeOrder:pe,fetchOrders:H,printStruck:fe,newOrderDialog:m,rooms:v,selectedRoom:t,selectRoom:de,createOrder:ue,manageItemsDialog:q,currentOrder:h,currentOrderItems:Q,selectedItem:w,items:i,openManageItemsDialog:re,addItemToOrder:ne,closeManageItemsDialog:se,updateItemOrder:oe,printer:F,selectedPrinter:V,openPrintDialog:z,openPrintOrder:le,selectPrinter:me}}}),qe={class:"flex justify-between row q-mb-md"},Ve={class:"flex column q-mr-md"},Ae=s("div",{class:"text-h6 q-mb-md"},"Actions",-1),Re={class:"text-left"},$e=s("strong",null,"Order:",-1),Ne={class:"q-table"},Be=s("thead",null,[s("tr",null,[s("th",null,"Name"),s("th",null,"Quantity"),s("th",null,"Price")])],-1),Me=s("strong",null,"Total Price:",-1),Ue=s("strong",null,"Total Items:",-1),Ee=s("div",{class:"text-h6",style:{"margin-bottom":"20px"}},"Select a Room",-1),je=s("div",{class:"text-h6",style:{"margin-bottom":"20px"}},"Select Printer",-1),ze=s("div",{class:"text-h6"},"Manage Items",-1),Fe={key:0,class:"q-mt-md"},He=s("div",{class:"text-subtitle2"},"Current Items",-1);function Je(e,l,o,p,m,v){return d(),y(C,null,[a(he,{padding:""},{default:r(()=>[s("div",qe,[s("div",Ve,[Ae,a(u,{label:"Create New Order",color:"primary",onClick:e.openNewOrder,class:"q-mb-md buttonAction"},null,8,["onClick"])])]),a(ge,{title:"Orders",rows:e.orders,columns:e.columns,"row-key":"orderId"},{header:r(t=>[a(_,{props:t},{default:r(()=>[a(A,{"auto-width":""}),(d(!0),y(C,null,I(t.cols,i=>(d(),g(A,{key:i.name,props:t},{default:r(()=>[b(f(i.label),1)]),_:2},1032,["props"]))),128)),a(A,{"auto-width":""},{default:r(()=>[b("Action")]),_:1})]),_:2},1032,["props"])]),body:r(t=>[a(_,{props:t},{default:r(()=>[a(S,null,{default:r(()=>[a(u,{size:"sm",color:"accent",round:"",dense:"",onClick:i=>t.expand=!t.expand,icon:t.expand?"remove":"add"},null,8,["onClick","icon"])]),_:2},1024),(d(!0),y(C,null,I(t.cols,i=>(d(),g(S,{key:i.name,props:t},{default:r(()=>[b(f(i.value),1)]),_:2},1032,["props"]))),128)),a(S,null,{default:r(()=>[a(u,{flat:"",icon:"print",onClick:i=>e.openPrintOrder(t.row)},null,8,["onClick"]),t.row.status!=="completed"?(d(),g(u,{key:0,flat:"",icon:"task_alt",onClick:i=>e.closeOrder(t.row)},null,8,["onClick"])):T("",!0)]),_:2},1024)]),_:2},1032,["props"]),t.row.itemSummary?L((d(),g(_,{key:0,props:t},{default:r(()=>[a(S,{colspan:t.cols.length+1},{default:r(()=>[s("div",Re,[$e,s("table",Ne,[Be,s("tbody",null,[(d(!0),y(C,null,I(t.row.itemSummary.items,i=>(d(),y("tr",{key:i.itemId},[s("td",null,f(i.name),1),s("td",null,f(i.quantity),1),s("td",null,f(i.price),1)]))),128))])]),s("div",null,[Me,b(" "+f(t.row.itemSummary.totalPrices),1)]),s("div",null,[Ue,b(" "+f(t.row.itemSummary.totalItem),1)])]),s("div",null,[t.row.endTime?T("",!0):(d(),g(u,{key:0,label:"Add Item",color:"primary",onClick:i=>e.openManageItemsDialog(t.row)},null,8,["onClick"]))])]),_:2},1032,["colspan"])]),_:2},1032,["props"])),[[W,t.expand]]):L((d(),g(_,{key:1},{default:r(()=>[a(S,{colspan:"100%"},{default:r(()=>[t.row.endTime?T("",!0):(d(),g(u,{key:0,label:"Add Item",color:"primary",onClick:i=>e.openManageItemsDialog(t.row)},null,8,["onClick"]))]),_:2},1024)]),_:2},1536)),[[W,t.expand]])]),_:1},8,["rows","columns"])]),_:1}),a(E,{modelValue:e.newOrderDialog,"onUpdate:modelValue":l[2]||(l[2]=t=>e.newOrderDialog=t),persistent:""},{default:r(()=>[a($,null,{default:r(()=>[a(O,{class:"row items-center"},{default:r(()=>[a(j),a(u,{icon:"close",flat:"",round:"",onClick:l[0]||(l[0]=t=>e.newOrderDialog=!1)})]),_:1}),a(O,null,{default:r(()=>[Ee,a(M,null,{default:r(()=>[(d(!0),y(C,null,I(e.rooms,t=>(d(),g(B,{key:t.id,clickable:"",class:Y({"selected-room":e.selectedRoom===t}),onClick:i=>e.selectRoom(t)},{default:r(()=>[a(N,null,{default:r(()=>[b(f(t.description),1)]),_:2},1024)]),_:2},1032,["class","onClick"]))),128))]),_:1})]),_:1}),a(U,{align:"right"},{default:r(()=>[a(u,{flat:"",label:"Cancel",color:"negative",onClick:l[1]||(l[1]=t=>e.newOrderDialog=!1)}),a(u,{flat:"",label:"Create Order",color:"primary",onClick:e.createOrder,disabled:!e.selectedRoom},null,8,["onClick","disabled"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),a(E,{modelValue:e.openPrintDialog,"onUpdate:modelValue":l[5]||(l[5]=t=>e.openPrintDialog=t),persistent:""},{default:r(()=>[a($,null,{default:r(()=>[a(O,{class:"row items-center"},{default:r(()=>[a(j),a(u,{icon:"close",flat:"",round:"",onClick:l[3]||(l[3]=t=>e.openPrintDialog=!1)})]),_:1}),a(O,null,{default:r(()=>[je,a(M,null,{default:r(()=>[(d(!0),y(C,null,I(e.printer,t=>(d(),g(B,{key:t.id,clickable:"",class:Y({"selected-printer":e.selectedPrinter===t}),onClick:i=>e.selectPrinter(t)},{default:r(()=>[a(N,null,{default:r(()=>[b(f(t.description),1)]),_:2},1024)]),_:2},1032,["class","onClick"]))),128))]),_:1})]),_:1}),a(U,{align:"right"},{default:r(()=>[a(u,{flat:"",label:"Cancel",color:"negative",onClick:l[4]||(l[4]=t=>e.openPrintDialog=!1)}),a(u,{flat:"",label:"Print",color:"primary",onClick:e.printStruck,disabled:!e.selectedRoom},null,8,["onClick","disabled"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),a(E,{modelValue:e.manageItemsDialog,"onUpdate:modelValue":l[8]||(l[8]=t=>e.manageItemsDialog=t)},{default:r(()=>[a($,null,{default:r(()=>[a(O,{class:"row items-center"},{default:r(()=>[ze,a(j),a(u,{icon:"close",flat:"",round:"",onClick:e.closeManageItemsDialog},null,8,["onClick"])]),_:1}),a(O,null,{default:r(()=>[s("div",null,[a(Ie,{modelValue:e.selectedItem,"onUpdate:modelValue":l[6]||(l[6]=t=>e.selectedItem=t),label:"Select Item",options:e.items,"option-value":"id","option-label":"name",class:"q-mb-md",placeholder:"Choose an item"},null,8,["modelValue","options"]),e.selectedItem?(d(),g(Oe,{key:0,type:"number",modelValue:e.selectedItem.quantity,"onUpdate:modelValue":l[7]||(l[7]=t=>e.selectedItem.quantity=t),label:"Quantity",class:"q-mb-md"},null,8,["modelValue"])):T("",!0),a(u,{label:"Add Item",onClick:e.addItemToOrder,color:"primary"},null,8,["onClick"])]),e.currentOrderItems.length>0?(d(),y("div",Fe,[He,a(M,{bordered:""},{default:r(()=>[(d(!0),y(C,null,I(e.currentOrderItems,(t,i)=>(d(),g(B,{key:i},{default:r(()=>[a(N,null,{default:r(()=>[b(f(t.name)+" - "+f(t.quantity)+" - Rp. "+f(t.price),1)]),_:2},1024)]),_:2},1024))),128))]),_:1})])):T("",!0)]),_:1}),a(U,{align:"right"},{default:r(()=>[a(u,{flat:"",label:"Update",onClick:e.updateItemOrder},null,8,["onClick"]),a(u,{flat:"",label:"Close",onClick:e.closeManageItemsDialog},null,8,["onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"])],64)}var dt=be(_e,[["render",Je]]);export{dt as default};
